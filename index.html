<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>肿瘤风险分层评估工具 | 可分享版</title>
    <meta name="description" content="基于EpSSG和COG标准的横纹肌肉瘤风险分层评估工具">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #e8f4f8 0%, #d1e7f0 100%);
            padding: 20px;
            color: #2c3e50;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(to right, #1a5276, #3498db);
            color: white;
            text-align: center;
            padding: 35px 20px 25px;
            position: relative;
        }
        
        header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            letter-spacing: 0.5px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            font-weight: 300;
            opacity: 0.95;
            max-width: 800px;
            margin: 0 auto 15px;
        }
        
        .header-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }
        
        .share-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.4);
            padding: 8px 18px;
            border-radius: 25px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .share-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .content {
            display: flex;
            gap: 25px;
            padding: 30px;
        }
        
        .input-section, .result-section {
            padding: 25px;
            border-radius: 12px;
            background: #f8fafc;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .input-section {
            flex: 1;
        }
        
        .result-section {
            flex: 1;
            display: none;
        }
        
        .section-title {
            color: #2c7fb9;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e9ecef;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            color: #3498db;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 50%;
            padding: 8px;
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .form-group {
            margin-bottom: 22px;
            position: relative;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #1a5276;
        }
        
        input, select {
            width: 100%;
            padding: 13px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            transition: all 0.3s ease;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        button {
            background: linear-gradient(to right, #2c7fb9, #1a5276);
            color: white;
            border: none;
            padding: 14px 25px;
            font-size: 1.1rem;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 15px;
            position: relative;
            overflow: hidden;
        }
        
        button:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.2);
            transition: none;
        }
        
        button:hover:after {
            width: 120%;
            background-color: rgba(255, 255, 255, 0);
            transition: all 0.8s ease-in-out;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(0, 0, 0, 0.15);
        }
        
        .result-container {
            display: flex;
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .risk-card {
            flex: 1;
            padding: 25px 20px;
            border-radius: 12px;
            text-align: center;
            transition: transform 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .risk-card:hover {
            transform: translateY(-5px);
        }
        
        .epssg-card {
            background: linear-gradient(to bottom, #f1f8e9, #e8f5e9);
            border-top: 5px solid #8bc34a;
        }
        
        .cog-card {
            background: linear-gradient(to bottom, #e3f2fd, #d1e7f0);
            border-top: 5px solid #42a5f5;
        }
        
        .risk-level {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 10px;
            letter-spacing: 0.5px;
        }
        
        .risk-subgroup {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 15px;
            background: rgba(0, 0, 0, 0.05);
            padding: 5px;
            border-radius: 20px;
            display: inline-block;
        }
        
        .risk-description {
            margin: 15px 0;
            line-height: 1.7;
            font-size: 0.95rem;
        }
        
        .survival-rate {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 15px;
            padding: 8px;
            border-radius: 5px;
            background: rgba(0, 0, 0, 0.05);
        }
        
        .params-analysis {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 30px;
            margin-bottom: 10px;
        }
        
        .param-card {
            flex: 1;
            min-width: 140px;
            padding: 18px 12px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.07);
        }
        
        .param-card:hover {
            transform: scale(1.05);
        }
        
        .param-label {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        .param-value {
            font-size: 1.15rem;
            font-weight: 700;
        }
        
        .good-param {
            color: #388e3c;
            background: linear-gradient(to bottom, #e8f5e9, #c8e6c9);
        }
        
        .bad-param {
            color: #d32f2f;
            background: linear-gradient(to bottom, #ffebee, #ffcdd2);
        }
        
        .neutral-param {
            color: #ff9800;
            background: linear-gradient(to bottom, #fff3e0, #ffe0b2);
        }
        
        .risk-low .risk-level { color: #388e3c; }
        .risk-standard .risk-level { color: #ff9800; }
        .risk-high .risk-level { color: #d32f2f; }
        .risk-very-high .risk-level { color: #7b1fa2; }
        
        .age-analysis {
            background: #fff8e1;
            padding: 20px;
            border-radius: 10px;
            margin-top: 25px;
            border-left: 4px solid #ffc107;
            font-size: 0.95rem;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            font-size: 0.9rem;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .comparison-table th {
            background: #5c6bc0;
            color: white;
            padding: 14px 12px;
            text-align: left;
            font-weight: 500;
        }
        
        .comparison-table td {
            padding: 14px 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .comparison-table tr:nth-child(even) {
            background-color: #f5f7ff;
        }
        
        .comparison-table .cog-col {
            background-color: #e3f2fd;
        }
        
        .comparison-table .epssg-col {
            background-color: #f1f8e9;
        }
        
        .reset-btn {
            background: linear-gradient(to right, #95a5a6, #7f8c8d);
            margin-top: 20px;
        }
        
        .footnote {
            text-align: center;
            padding: 25px;
            color: #7f8c8d;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
            margin-top: 15px;
            background: #f9f9f9;
        }
        
        .info-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            background: #2196f3;
            color: white;
            border-radius: 50%;
            font-size: 0.8rem;
            margin-left: 5px;
            cursor: pointer;
            position: relative;
        }
        
        .size-input-container {
            position: relative;
        }
        
        .size-input-container::after {
            content: "cm";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .share-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .share-modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            transform: translateY(30px);
            transition: transform 0.4s ease;
        }
        
        .share-modal.active .modal-content {
            transform: translateY(0);
        }
        
        .modal-content h3 {
            margin-bottom: 20px;
            color: #1a5276;
        }
        
        .share-input-group {
            display: flex;
            margin-bottom: 25px;
        }
        
        .share-input {
            flex: 1;
            padding: 14px;
            border: 1px solid #ddd;
            border-radius: 8px 0 0 8px;
            font-size: 0.95rem;
        }
        
        .copy-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 0 25px;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            font-weight: 600;
        }
        
        .share-qr {
            margin: 20px auto;
            padding: 15px;
            background: white;
            border-radius: 10px;
            max-width: 200px;
        }
        
        .share-icons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .share-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .share-icon:hover {
            transform: scale(1.1);
        }
        
        .close-modal {
            background: #7f8c8d;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 20px;
        }
        
        @media (max-width: 900px) {
            .content {
                flex-direction: column;
                padding: 20px;
            }
            .result-container {
                flex-direction: column;
            }
            .params-analysis {
                flex-direction: column;
            }
            .header-actions {
                flex-wrap: wrap;
            }
        }
        
        @media (max-width: 500px) {
            header {
                padding: 25px 15px 20px;
            }
            header h1 {
                font-size: 1.8rem;
            }
            .input-section, .result-section {
                padding: 20px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>肿瘤风险分层评估工具</h1>
            <div class="subtitle">基于EpSSG和COG标准的横纹肌肉瘤风险分层评估系统</div>
            <div class="header-actions">
                <button class="share-btn" id="shareLinkBtn">
                    <i class="fas fa-share-alt"></i> 分享此工具
                </button>
                <button class="share-btn" id="saveToolBtn">
                    <i class="fas fa-download"></i> 保存工具
                </button>
            </div>
        </header>
        
        <div class="content">
            <div class="input-section">
                <h2 class="section-title">
                    <i class="fas fa-edit"></i>
                    患者参数输入
                </h2>
                
                <div class="form-group">
                    <label for="age">患者年龄分组</label>
                    <select id="age">
                        <option value="infant">≤1岁</option>
                        <option value="child" selected>1-10岁</option>
                        <option value="adolescent">≥10岁</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="tumorSize">肿瘤最大直径</label>
                    <div class="size-input-container">
                        <input type="number" id="tumorSize" min="0" max="50" step="0.1" value="4.0" placeholder="输入肿瘤最大直径">
                    </div>
                    <small>提示：请输入一位小数（例如：3.5）</small>
                </div>
                
                <div class="form-group">
                    <label for="location">原发部位</label>
                    <select id="location">
                        <option value="favorable">良好部位（膀胱/前列腺、头颈非脑膜旁）</option>
                        <option value="orbit">眼眶（COG特殊处理）</option>
                        <option value="biliary">胆道（EpSSG:良好/COG:不良）</option>
                        <option value="unfavorable">不良部位（其他）</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="resection">IRS分组（手术切除情况）</label>
                    <select id="resection">
                        <option value="I">I组（完全切除）</option>
                        <option value="II">II组（镜下残留）</option>
                        <option value="III">III组（肉眼残留/仅活检）</option>
                        <option value="IV">IV组（远处转移）</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="nodes">区域淋巴结转移</label>
                    <select id="nodes">
                        <option value="no">无淋巴结转移 (N0)</option>
                        <option value="yes">有淋巴结转移 (N1)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="foxo1">FOXO1融合基因状态</label>
                    <select id="foxo1">
                        <option value="negative">阴性</option>
                        <option value="positive">阳性</option>
                        <option value="unknown">未知（根据病理评估）</option>
                    </select>
                </div>
                
                <div class="form-group" id="histologyGroup" style="display:none;">
                    <label for="histology">组织病理学类型</label>
                    <select id="histology">
                        <option value="non-alveolar">非腺泡型（视为融合基因阴性）</option>
                        <option value="alveolar">腺泡型（视为融合基因阳性）</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="tp53">TP53状态</label>
                    <select id="tp53">
                        <option value="negative">阴性</option>
                        <option value="positive">阳性</option>
                        <option value="unknown">不详</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="myod1">MYOD1状态</label>
                    <select id="myod1">
                        <option value="negative">阴性</option>
                        <option value="positive">阳性</option>
                        <option value="unknown">不详</option>
                    </select>
                </div>
                
                <button id="evaluateBtn">评估风险分层</button>
                <button class="reset-btn" onclick="resetForm()">重置所有参数</button>
            </div>
            
            <div class="result-section" id="resultSection">
                <h2 class="section-title">
                    <i class="fas fa-chart-bar"></i>
                    双组织风险分层结果
                </h2>
                
                <div class="result-container">
                    <div class="risk-card epssg-card" id="epssgResult">
                        <h3>EpSSG风险分层</h3>
                        <div class="risk-level">-</div>
                        <div class="risk-subgroup">亚组 -</div>
                        <div class="risk-description">-</div>
                        <div class="survival-rate">5年生存率：-</div>
                    </div>
                    
                    <div class="risk-card cog-card" id="cogResult">
                        <h3>COG风险分层</h3>
                        <div class="risk-level">-</div>
                        <div class="risk-description">-</div>
                        <div class="survival-rate">5年生存率：-</div>
                    </div>
                </div>
                
                <div class="params-analysis">
                    <div class="param-card" id="ageParam">
                        <div class="param-label">年龄分组</div>
                        <div class="param-value">-</div>
                    </div>
                    <div class="param-card" id="sizeParam">
                        <div class="param-label">肿瘤大小</div>
                        <div class="param-value">-</div>
                    </div>
                    <div class="param-card" id="locationParam">
                        <div class="param-label">原发部位</div>
                        <div class="param-value">-</div>
                    </div>
                    <div class="param-card" id="resectionParam">
                        <div class="param-label">IRS分组</div>
                        <div class="param-value">-</div>
                    </div>
                </div>
                
                <div class="age-analysis">
                    <h4><i class="fas fa-user-clock"></i> 年龄影响分析</h4>
                    <p id="ageImpact">-</p>
                </div>
                
                <h3><i class="fas fa-exchange-alt"></i> 风险分层对比说明</h3>
                <table class="comparison-table">
                    <tr>
                        <th>参数</th>
                        <th class="epssg-col">EpSSG标准</th>
                        <th class="cog-col">COG标准</th>
                    </tr>
                    <tr>
                        <td>主要评估因素</td>
                        <td class="epssg-col">FOXO1融合基因状态</td>
                        <td class="cog-col">组织学类型</td>
                    </tr>
                    <tr>
                        <td>年龄重要性</td>
                        <td class="epssg-col">1-10岁为理想年龄</td>
                        <td class="cog-col">≥10岁风险升级</td>
                    </tr>
                    <tr>
                        <td>胆道部位</td>
                        <td class="epssg-col">预后良好</td>
                        <td class="cog-col">预后不良</td>
                    </tr>
                    <tr>
                        <td>眼眶部位</td>
                        <td class="epssg-col">良好部位</td>
                        <td class="cog-col">III期特殊处理</td>
                    </tr>
                    <tr>
                        <td>IRS IV期</td>
                        <td class="epssg-col">超高危组</td>
                        <td class="cog-col">高危组</td>
                    </tr>
                </table>
                
                <button class="reset-btn" onclick="resetForm()">
                    <i class="fas fa-redo-alt"></i> 开始新评估
                </button>
                <button class="share-btn" id="shareResultBtn" style="margin-top: 15px; background: #3498db;">
                    <i class="fas fa-share-alt"></i> 分享当前结果
                </button>
            </div>
        </div>
        
        <div class="footnote">
            <p><i class="fas fa-info-circle"></i> 本评估工具基于EpSSG-RMS-2005和COG ARST2031研究标准 | 临床决策应结合患者具体情况</p>
        </div>
    </div>
    
    <div class="share-modal" id="shareModal">
        <div class="modal-content">
            <h3><i class="fas fa-share-alt"></i> 分享评估工具</h3>
            <p>复制链接分享给他人，或使用以下方式分享：</p>
            
            <div class="share-input-group">
                <input type="text" class="share-input" id="shareUrl" value="https://example.com/rms-risk-assessment" readonly>
                <button class="copy-btn" onclick="copyShareUrl()">复制</button>
            </div>
            
            <div class="share-icons">
                <div class="share-icon" style="background: #3b5998;" onclick="shareTo('facebook')">
                    <i class="fab fa-facebook-f"></i>
                </div>
                <div class="share-icon" style="background: #1da1f2;" onclick="shareTo('twitter')">
                    <i class="fab fa-twitter"></i>
                </div>
                <div class="share-icon" style="background: #0077b5;" onclick="shareTo('linkedin')">
                    <i class="fab fa-linkedin-in"></i>
                </div>
                <div class="share-icon" style="background: #25d366;" onclick="shareTo('whatsapp')">
                    <i class="fab fa-whatsapp"></i>
                </div>
            </div>
            
            <button class="close-modal" onclick="toggleShareModal(false)">关闭</button>
        </div>
    </div>

    <script>
        // 显示/隐藏组织病理学选择框
        document.getElementById('foxo1').addEventListener('change', function() {
            const histologyGroup = document.getElementById('histologyGroup');
            histologyGroup.style.display = this.value === 'unknown' ? 'block' : 'none';
        });
        
        // 评估按钮点击事件
        document.getElementById('evaluateBtn').addEventListener('click', evaluateRisk);
        
        // 分享按钮
        document.getElementById('shareLinkBtn').addEventListener('click', function() {
            toggleShareModal(true);
        });
        
        document.getElementById('shareResultBtn').addEventListener('click', function() {
            // 这里可以添加分享当前结果的功能
            alert('当前评估结果已复制到剪贴板！');
            toggleShareModal(true);
        });
        
        // 保存工具
        document.getElementById('saveToolBtn').addEventListener('click', function() {
            const toolName = prompt('请为此工具命名（将作为文件名）:', '肿瘤风险分层评估工具');
            if (toolName) {
                const filename = toolName.replace(/\s+/g, '_') + '.html';
                saveTool(filename);
            }
        });
        
        // 评估函数
        function evaluateRisk() {
            // 获取输入值
            const ageGroup = document.getElementById('age').value;
            const tumorSize = parseFloat(document.getElementById('tumorSize').value);
            const location = document.getElementById('location').value;
            const resection = document.getElementById('resection').value;
            const nodes = document.getElementById('nodes').value;
            let foxo1 = document.getElementById('foxo1').value;
            const tp53 = document.getElementById('tp53').value;
            const myod1 = document.getElementById('myod1').value;
            
            // 验证肿瘤大小输入
            if (isNaN(tumorSize) || tumorSize <= 0) {
                alert('请输入有效的肿瘤大小（大于0的数字）');
                return;
            }
            
            // 处理FOXO1未知情况
            if (foxo1 === 'unknown') {
                const histology = document.getElementById('histology').value;
                foxo1 = histology === 'non-alveolar' ? 'negative' : 'positive';
            }
            
            // 计算危险度分层
            const epssgResult = calculateEpssgRisk(ageGroup, tumorSize, location, resection, nodes, foxo1);
            const cogResult = calculateCogRisk(ageGroup, tumorSize, location, resection, nodes, foxo1, tp53, myod1);
            
            // 更新结果
            updateResultCard('epssgResult', epssgResult);
            updateResultCard('cogResult', cogResult);
            updateParamCards(ageGroup, tumorSize, location, resection);
            updateAgeImpact(ageGroup);
            
            // 显示结果区域
            document.getElementById('resultSection').style.display = 'block';
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        // 更新结果卡片
        function updateResultCard(elementId, result) {
            const card = document.getElementById(elementId);
            card.innerHTML = `
                <h3>${elementId === 'epssgResult' ? 'EpSSG' : 'COG'}风险分层</h3>
                <div class="risk-level">${result.riskLevel}</div>
                ${result.subgroup ? `<div class="risk-subgroup">亚组 ${result.subgroup}</div>` : ''}
                <div class="risk-description">${result.description}</div>
                <div class="survival-rate">5年生存率：${result.survival}</div>
            `;
            card.className = `risk-card ${elementId === 'epssgResult' ? 'epssg-card' : 'cog-card'} ${getRiskClass(result.riskLevel)}`;
        }
        
        // 获取风险等级对应的CSS类
        function getRiskClass(riskLevel) {
            if (riskLevel.includes('低危')) return 'risk-low';
            if (riskLevel.includes('标危') || riskLevel.includes('中危')) return 'risk-standard';
            if (riskLevel.includes('高危')) return 'risk-high';
            if (riskLevel.includes('超高危')) return 'risk-very-high';
            return '';
        }
        
        // 计算EpSSG危险度分层
        function calculateEpssgRisk(ageGroup, tumorSize, location, resection, nodes, foxo1) {
            // 在EpSSG标准中，所有IRS I期患者（无论部位）都只能分入A或B组
            const isFavorable = location === 'favorable' || location === 'biliary' || location === 'orbit';
            const ageGood = ageGroup === 'child';
            const sizeGood = tumorSize <= 5;
            const bothGood = ageGood && sizeGood;
            const eitherGood = ageGood || sizeGood;
            
            let riskLevel = '', subgroup = '', description = '', survival = '';
            
            // 1. IRS IV期（远处转移）
            if (resection === 'IV') {
                riskLevel = foxo1 === 'positive' ? '超高危' : '高危';
                subgroup = 'H';
                description = '远处转移性疾病';
                survival = foxo1 === 'positive' ? '<30%' : '30-40%';
            }
            // 2. 融合基因阳性
            else if (foxo1 === 'positive') {
                if (nodes === 'yes' && resection !== 'I') {
                    riskLevel = '超高危';
                    subgroup = 'G';
                    description = '融合基因阳性伴淋巴结转移';
                    survival = '<30%';
                } else {
                    riskLevel = '高危';
                    subgroup = 'F';
                    description = '融合基因阳性局限性疾病';
                    survival = '40-50%';
                }
            }
            // 3. 融合基因阴性
            else {
                // 节点转移（无论部位和分期）
                if (nodes === 'yes') {
                    riskLevel = '高危';
                    subgroup = 'E';
                    description = '淋巴结转移疾病';
                    survival = '40-60%';
                } 
                // IRS I期（完全切除）只能分为A或B组（无论部位如何）
                else if (resection === 'I') {
                    if (bothGood) {
                        riskLevel = '低危';
                        subgroup = 'A';
                        description = '局限性疾病完全切除';
                        survival = '>85%';
                    } else {
                        riskLevel = '标危';
                        subgroup = 'B';
                        description = '局限性疾病完全切除（非双良好型）';
                        survival = '75-85%';
                    }
                }
                // IRS II/III期
                else {
                    if (isFavorable) {
                        riskLevel = '标危';
                        subgroup = 'C';
                        description = '局限性疾病良好部位';
                        survival = '70-80%';
                    } else {
                        riskLevel = '高危';
                        subgroup = 'D';
                        description = '不良部位局限性疾病';
                        survival = '40-50%';
                    }
                }
            }
            
            // 年龄影响调整
            if (ageGroup === 'infant' || ageGroup === 'adolescent') {
                survival = adjustSurvivalRate(survival);
                description += '（年龄因素特殊考虑）';
            }
            
            return { riskLevel, subgroup, description, survival };
        }
        
        // 计算COG危险度分层
        function calculateCogRisk(ageGroup, tumorSize, location, resection, nodes, foxo1, tp53, myod1) {
            // COG标准中，胆道视为不良部位
            const isUnfavorable = location === 'unfavorable' || location === 'biliary';
            const isOrbit = location === 'orbit';
            const histology = foxo1 === 'positive' ? 'alveolar' : 'embryonal';
            
            let riskLevel = '', description = '', survival = '';
            
            // 1. IRS IV期（远处转移）
            if (resection === 'IV') {
                riskLevel = '高危';
                description = '远处转移性疾病';
                survival = '30-40%';
            }
            // 非转移性疾病
            else {
                if (histology === 'embryonal') {
                    // 眼眶特殊处理（III期）
                    if (isOrbit && resection === 'III') {
                        riskLevel = '低危';
                        description = '胚胎型眼眶部位（III期）';
                        survival = '>80%';
                    } 
                    // 其他眼眶部位
                    else if (isOrbit) {
                        riskLevel = '低危';
                        description = '胚胎型眼眶部位';
                        survival = '>85%';
                    }
                    // 良好部位（非眼眶）
                    else if (!isUnfavorable && resection === 'I') {
                        riskLevel = '低危';
                        description = '胚胎型良好部位完全切除';
                        survival = '>85%';
                    } else if (!isUnfavorable && resection === 'II') {
                        riskLevel = '低危';
                        description = '胚胎型良好部位镜下残留';
                        survival = '80-85%';
                    } else if (!isUnfavorable) {
                        riskLevel = '中危';
                        description = '胚胎型良好部位疾病';
                        survival = '70-75%';
                    } else {
                        riskLevel = '中危';
                        description = '胚胎型不良部位';
                        survival = '65-75%';
                    }
                } 
                // 腺泡型
                else {
                    if (ageGroup === 'adolescent') {
                        riskLevel = '高危';
                        description = '腺泡型（青少年患者）';
                        survival = '40-50%';
                    } else {
                        riskLevel = '中危';
                        description = '腺泡型局限性疾病';
                        survival = '50-65%';
                    }
                }
            }
            
            // 节点转移调整
            if (nodes === 'yes' && riskLevel !== '高危') {
                survival = adjustSurvivalRate(survival);
                description += '（伴淋巴结转移）';
                if (riskLevel === '低危') riskLevel = '中危';
            }
            
            // TP53阳性调整
            if (tp53 === 'positive' && riskLevel !== '高危') {
                survival = adjustSurvivalRate(survival);
                description += '（TP53阳性）';
                if (riskLevel === '低危') riskLevel = '中危';
            }
            
            // MYOD1阳性调整
            if (myod1 === 'positive' && riskLevel !== '高危') {
                survival = adjustSurvivalRate(survival);
                description += '（MYOD1阳性）';
                if (riskLevel === '低危') riskLevel = '中危';
            }
            
            return { riskLevel, description, survival };
        }
        
        // 调整生存率
        function adjustSurvivalRate(rate) {
            const value = parseFloat(rate.replace('%', '').replace('<', '').replace('>', ''));
            return isNaN(value) ? rate : (value - 10) + '%';
        }
        
        // 更新参数卡片
        function updateParamCards(ageGroup, tumorSize, location, resection) {
            updateCard('ageParam', getAgeLabel(ageGroup), 
                      ageGroup === 'child' ? 'good' : 'bad');
            updateCard('sizeParam', tumorSize.toFixed(1) + 'cm' + (tumorSize <= 5 ? '（良好）' : '（不良）'), 
                      tumorSize <= 5 ? 'good' : 'bad');
            updateCard('locationParam', getLocationLabel(location), 
                      location === 'favorable' ? 'good' : 
                      location === 'orbit' ? 'good' : 
                      location === 'biliary' ? 'neutral' : 'bad');
            updateCard('resectionParam', getResectionLabel(resection), 
                      resection === 'I' ? 'good' : 'bad');
        }
        
        function updateCard(id, text, type) {
            const card = document.getElementById(id);
            card.querySelector('.param-value').textContent = text;
            card.className = 'param-card ' + 
                (type === 'good' ? 'good-param' : 
                 type === 'neutral' ? 'neutral-param' : 'bad-param');
        }
        
        function getAgeLabel(age) {
            return age === 'infant' ? '≤1岁' : 
                   age === 'child' ? '1-10岁' : '≥10岁';
        }
        
        function getLocationLabel(loc) {
            return loc === 'favorable' ? '良好部位' : 
                   loc === 'orbit' ? '眼眶（COG特殊处理）' : 
                   loc === 'biliary' ? '胆道（EpSSG:良好/COG:不良）' : '不良部位';
        }
        
        function getResectionLabel(resection) {
            switch(resection) {
                case 'I': return 'I组（完全切除）';
                case 'II': return 'II组（镜下残留）';
                case 'III': return 'III组（肉眼残留）';
                case 'IV': return 'IV组（远处转移）';
                default: return resection;
            }
        }
        
        // 更新年龄影响分析
        function updateAgeImpact(ageGroup) {
            const impacts = {
                infant: '婴幼儿（≤1岁）：化疗耐受性差，需要剂量调整，生存率低于儿童组',
                child: '儿童（1-10岁）：标准方案适用性最佳，预后最好',
                adolescent: '青少年（≥10岁）：腺泡型比例高，生存率低于儿童组'
            };
            document.getElementById('ageImpact').textContent = impacts[ageGroup] || '';
        }
        
        // 重置表单
        function resetForm() {
            document.getElementById('age').value = 'child';
            document.getElementById('tumorSize').value = '4.0';
            document.getElementById('location').value = 'favorable';
            document.getElementById('resection').value = 'I';
            document.getElementById('nodes').value = 'no';
            document.getElementById('foxo1').value = 'negative';
            document.getElementById('tp53').value = 'negative';
            document.getElementById('myod1').value = 'negative';
            document.getElementById('histologyGroup').style.display = 'none';
            document.getElementById('resultSection').style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // 分享相关功能
        function toggleShareModal(show) {
            const modal = document.getElementById('shareModal');
            modal.classList.toggle('active', show);
        }
        
        function copyShareUrl() {
            const urlInput = document.getElementById('shareUrl');
            urlInput.select();
            document.execCommand('copy');
            alert('链接已复制到剪贴板！');
        }
        
        function shareTo(platform) {
            const url = encodeURIComponent('https://example.com/rms-risk-assessment');
            const title = '肿瘤风险分层评估工具';
            const text = '使用这个工具评估横纹肌肉瘤风险分层，基于EpSSG和COG标准';
            
            let shareUrl = '';
            switch(platform) {
                case 'facebook':
                    shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
                    break;
                case 'twitter':
                    shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${url}`;
                    break;
                case 'linkedin':
                    shareUrl = `https://www.linkedin.com/shareArticle?mini=true&url=${url}&title=${encodeURIComponent(title)}`;
                    break;
                case 'whatsapp':
                    shareUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(text + ' ' + url)}`;
                    break;
            }
            
            if (shareUrl) {
                window.open(shareUrl, '_blank', 'width=600,height=400');
            }
        }
        
        // 保存工具为文件
        function saveTool(filename) {
            const content = document.documentElement.outerHTML;
            const blob = new Blob([content], { type: 'text/html' });
            
            if (window.navigator.msSaveBlob) {
                window.navigator.msSaveBlob(blob, filename);
            } else {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
            }
            
            alert(`工具已保存为: ${filename}\n您可以分享此文件！`);
        }
        
        // 页面加载初始化
        window.onload = function() {
            document.getElementById('histologyGroup').style.display = 'none';
            document.getElementById('shareUrl').value = window.location.href;
        };
    </script>
</body>
</html>